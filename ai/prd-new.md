# GMX Synthetics 产品需求文档（PRD）
 
---

## 1. 核心用户与使用场景

### 1.1 流动性提供者（LP）

**用户画像**：拥有闲置加密资产，寻求稳定收益的投资者

**核心用户故事**：
> **作为** 一个持有 ETH 和 USDC 的投资者，  
> **我希望** 能够安全地提供流动性并获得被动收入，  
> **以便于** 我的闲置资产可以产生持续的收益回报。

**具体使用场景**：
- **场景描述**：用户向 ETH/USD 市场存入 10 ETH + 30,000 USDC
- **操作流程**：
  1. 连接钱包，选择目标市场
  2. 输入存款金额，确认交易（**仅需1次签名**）
  3. **等待 Keeper 执行**：存款请求进入队列，等待专业 Keeper 在下一区块执行
  4. **执行过程**：Keeper 获取最新预言机价格，计算并铸造 LP 代币（通常 2-5 分钟）
  5. 开始获得交易手续费和借贷费用分成

**收益预期**：年化收益率 8-15%，由以下部分组成：
- 交易手续费分成（约 60%）
- 借贷费用分成（约 30%）
- 交易者亏损收益（约 10%）

### 1.2 永续合约交易者

**用户画像**：专业交易者或有杠杆交易需求的投资者

**核心用户故事**：
> **作为** 一个看好 ETH 长期走势的交易者，  
> **我希望** 使用 10 倍杠杆做多 ETH，并设置止损保护，  
> **以便于** 我能够放大收益的同时控制风险。

**具体使用场景**：
- **场景描述**：用户开立 10 倍杠杆 ETH 多头仓位
- **操作流程**：
  1. 存入 1,000 USDC 作为保证金
  2. 选择 10 倍杠杆，开立 10,000 USDC 规模多头仓位
  3. 设置止损价格（如当前价格的 95%）
  4. 系统自动监控，触发条件时执行止损

**交易成本**：
- 开仓费用：0.05%-0.1%
- 资金费用：根据多空平衡动态调整
- 借贷费用：年化 2-8%

### 1.3 交换用户

**用户画像**：需要大额代币兑换的 DeFi 用户

**核心用户故事**：
> **作为** 一个需要兑换大额代币的用户，  
> **我希望** 获得更好的价格和更低的滑点，  
> **以便于** 减少我的交易成本。

**具体使用场景**：
- **场景描述**：用户将 100 ETH 兑换为 USDC
- **操作流程**：
  1. 输入兑换数量，查看预估输出和滑点
  2. 确认交易，系统自动路由最优路径
  3. 通过多个流动性池完成兑换，获得最佳价格

### 1.4 系统运营者（Keeper）

**用户画像**：专业的区块链服务提供商或协议运营团队

**核心用户故事**：
> **作为** 系统 Keeper 运营者，  
> **我希望** 能够及时执行用户请求并获得执行奖励，  
> **以便于** 维护系统正常运行并获得稳定收益。

#### 场景 1：执行用户存款请求

**场景描述**：Keeper 监控并执行待处理的流动性存款请求

**操作流程**：
1. 监控区块链上的存款请求事件
2. 等待区块确认（通常 1-2 个区块）
3. 获取最新的预言机价格数据
4. 调用执行函数完成存款，铸造 LP 代币
5. 获得执行费用奖励（通常 1-5 USDC）

**技术要求**：
- 24/7 监控系统运行
- 快速获取和验证预言机价格
- Gas 费用优化和批量执行能力
- 失败重试和错误处理机制

#### 场景 2：执行交易订单

**场景描述**：Keeper 执行用户提交的永续合约交易订单

**操作流程**：
1. 扫描订单池中的待执行订单
2. 验证订单执行条件（价格触发、保证金充足等）
3. 获取实时价格数据并验证偏差范围
4. 执行订单：开仓、平仓或调整仓位
5. 更新用户仓位状态和市场数据
6. 收取执行费用（0.1-0.5% 或固定费用）

**执行优先级**：
- 紧急平仓（强制清算）：最高优先级
- 止损/止盈触发：高优先级
- 市价单：中等优先级
- 限价单：低优先级

#### 场景 3：执行自动减仓（ADL）

**场景描述**：当市场出现极端情况时，Keeper 执行自动减仓机制

**触发条件**：
- 某个方向仓位敞口过大（超过设定阈值）
- 流动性不足以支持正常清算
- 价格大幅波动导致系统风险增加

**操作流程**：
1. 监控市场风险指标（敞口比率、流动性指标）
2. 识别需要减仓的盈利仓位（按盈利率排序）
3. 计算最优减仓数量和价格
4. 执行自动减仓，强制平部分盈利仓位
5. 更新市场平衡状态
6. 向受影响用户发放补偿（通常为减仓费用）

**风险控制**：
- 严格按照算法选择减仓目标
- 实时计算和验证减仓影响
- 确保减仓过程透明可审计

#### 场景 4：执行清算操作

**场景描述**：Keeper 清算保证金不足的用户仓位

**清算触发条件**：
- 用户保证金率 < 维持保证金率（通常 2-5%）
- 未实现亏损超过可承受范围
- 借贷费用累积导致保证金不足

**操作流程**：
1. 实时监控所有用户仓位的保证金状态
2. 识别触发清算条件的仓位
3. 验证清算的合规性和必要性
4. 执行强制平仓，计算清算价格
5. 分配清算费用：
   - 清算者奖励：1-5%
   - 保险基金：剩余部分
   - 用户：扣除费用后的剩余保证金

**保护机制**：
- 部分清算：优先尝试部分平仓恢复保证金率
- 价格保护：避免清算造成过大价格冲击
- 时间延迟：给用户补充保证金的缓冲时间

#### 场景 5：资金费率结算

**场景描述**：Keeper 定期执行资金费率结算

**执行频率**：每 8 小时结算一次

**操作流程**：
1. 计算当前期间的资金费率
2. 统计所有多头和空头仓位
3. 计算每个仓位应付/应收的资金费用
4. 批量执行资金费用转移
5. 更新用户账户余额
6. 记录结算数据供审计使用

**资金费率计算**：
```
资金费率 = (多头未平仓合约价值 - 空头未平仓合约价值) / 总未平仓合约价值 × 费率系数
用户应付费用 = 仓位规模 × 资金费率 × 时间权重
```

**Keeper 激励机制**：
- **基础执行费**：每次成功执行获得固定费用
- **复杂度奖励**：根据操作复杂程度获得额外奖励
- **及时性奖励**：快速响应获得时间奖励
- **质量保证**：错误执行面临罚金扣除

### 1.5 协议治理者

**用户画像**：GMX代币持有者、DAO成员、协议核心团队

**核心用户故事**：
> **作为** 协议治理参与者，  
> **我希望** 通过民主决策机制参与协议重大决策，  
> **以便于** 确保协议长期健康发展并保护所有参与者利益。

#### 场景 1：参数调整治理

**场景描述**：治理者投票决定关键协议参数的调整

**治理范围**：
- **费率参数**：交易手续费、借贷费率、资金费率
- **风控参数**：最大杠杆倍数、维持保证金比例、清算阈值
- **限额设置**：单个市场最大敞口、用户持仓限额
- **激励参数**：Keeper奖励、流动性挖矿分配

**治理流程**：
1. **提案阶段**：社区成员或核心团队提出参数调整提案
2. **讨论期**：7天社区讨论，收集反馈和建议
3. **投票期**：持有GMX代币的用户进行链上投票（持续3天）
4. **执行延迟**：通过提案后24-48小时执行，确保用户有时间调整策略
5. **参数生效**：新参数通过时间锁合约自动生效

**投票权重**：
```
投票权重 = GMX代币持有量 × 代币锁定时间权重
最大权重系数 = 2.0（锁定4年时）
最小权重系数 = 1.0（无锁定）
```

#### 场景 2：紧急响应治理

**场景描述**：面对安全威胁或市场极端情况的紧急治理响应

**紧急权限**：
- **功能暂停**：立即暂停特定功能（存款、提款、交易）
- **参数紧急调整**：风险参数的快速调整（如降低杠杆上限）
- **资金保护**：激活保险基金或紧急流动性支持
- **系统升级**：关键安全补丁的快速部署

**紧急治理流程**：
1. **威胁识别**：监控系统发现异常或收到安全报告
2. **紧急委员会**：5-7人紧急委员会快速评估和决策
3. **多签执行**：3/5多签即可执行紧急措施
4. **社区通知**：立即向社区公告紧急措施和原因
5. **后续治理**：72小时内进行正式治理投票确认或撤销

**紧急委员会成员**：
- 核心开发团队代表（2名）
- 大户代表（2名）
- 社区选举代表（2名）
- 安全专家（1名）

#### 场景 3：协议升级治理

**场景描述**：重大协议功能更新和合约升级的治理决策

**升级类型**：
- **功能添加**：新交易对上线、新产品功能
- **安全升级**：合约安全性改进、漏洞修复
- **性能优化**：Gas费用优化、执行效率提升
- **集成扩展**：与其他协议的集成、跨链支持

**升级治理流程**：
1. **技术提案**：详细技术规范和影响评估（21天讨论期）
2. **安全审计**：独立第三方安全审计报告
3. **测试网验证**：在测试网进行完整功能测试
4. **社区投票**：正式链上投票（7天投票期）
5. **分阶段部署**：
   - 第一阶段：非关键功能部署
   - 第二阶段：核心功能升级
   - 第三阶段：全面激活新功能

#### 场景 4：收益分配治理

**场景描述**：协议收入分配机制的治理决策

**收入来源**：
- 交易手续费收入（协议留存部分）
- 清算费用分成
- 价格影响费用
- 其他协议运营收入

**分配选项**：
```
收入分配方案投票：
选项A：50%回购销毁 + 30%开发基金 + 20%保险基金
选项B：40%代币持有者分红 + 40%开发基金 + 20%保险基金
选项C：60%生态发展基金 + 25%保险基金 + 15%团队激励
```

**治理决策权重**：
- **代币持有量**：基础投票权
- **参与度奖励**：活跃治理参与者获得额外权重
- **专业背景**：技术专家、风险专家意见权重加成

#### 场景 5：合作伙伴治理

**场景描述**：重要合作伙伴关系和生态扩展的治理决策

**合作类型**：
- **预言机合作**：新预言机服务商集成
- **技术集成**：与其他DeFi协议的深度集成
- **跨链扩展**：在新区块链上部署协议
- **战略投资**：协议资金的对外投资决策

**治理标准**：
- **技术兼容性**：技术架构匹配度评估
- **安全性评估**：合作方安全历史和当前状态
- **社区利益**：对GMX生态的长期价值贡献
- **财务影响**：成本效益分析和风险评估

**治理者激励机制**：
- **参与奖励**：积极参与治理获得GMX代币奖励
- **质量奖励**：高质量提案和分析获得额外奖励
- **长期激励**：长期持有和参与治理的复合奖励
- **专家认证**：专业贡献者获得治理权重加成

---

## 2. 核心功能需求

### 2.1 流动性管理系统

#### 功能：双代币流动性供应

**描述**：用户可以向指定市场提供长短代币组合流动性

**核心需求**：
- 支持任意比例的双代币存款（如 70% ETH + 30% USDC）
- 自动平衡机制：根据市场需求调整代币比例
- 实时计算预期 LP 代币数量和年化收益率
- 支持单币种存款，系统自动兑换为目标比例

**业务规则**：
- 最小存款金额：等值 100 USDC
- LP 代币价值根据池子总价值实时计算
- 存款执行时间：2-5 分钟（等待 keeper 执行）
- 提款冷却期：无（即时提款）

#### 功能：智能收益分配

**描述**：LP 自动获得多种收益来源的分成

**需求**：
- **交易手续费分成**：按 LP 份额比例分配
- **借贷费用分成**：从交易者支付的借贷费用中获得 85% 分成
- **交易者净亏损**：当交易者整体亏损时，增加池子价值

**业务规则**：
- 收益每秒实时累计到 LP 代币价值中
- 用户可随时查看实时收益情况
- 收益自动复投，无需额外操作

#### 功能：LP 份额计算公式

**第一步: 计算用户存款价值**
```
存款总价值 = 长代币数量 乘以 长代币价格 加上 短代币数量 乘以 短代币价格
```

**第二步: 计算池子总价值**

池子总价值包含四个部分的计算：

1. **基础代币池价值**
```
长代币价值 = 池中长代币数量 乘以 长代币当前价格
短代币价值 = 池中短代币数量 乘以 短代币当前价格
基础池价值 = 长代币价值 加上 短代币价值
```

2. **加上借贷费用收入**
```
多头借贷费用 = 所有多头仓位累计的借贷费用
空头借贷费用 = 所有空头仓位累计的借贷费用
总借贷费用 = 多头借贷费用 加上 空头借贷费用
池子借贷费用收入 = 总借贷费用 乘以 池子分成比例
调整后池价值 = 基础池价值 加上 池子借贷费用收入
```

3. **减去交易者未实现盈亏**

**多头仓位初始成本计算说明**：
- **openInterest（持仓总成本）**：记录所有多头仓位开仓时的美元总价值，这是交易者实际支付的总成本
- **openInterestInTokens（持仓代币总量）**：记录所有多头仓位对应的指数代币总数量
- **计算原理**：当交易者开多头仓位时，系统记录其开仓时支付的美元成本和获得的代币数量

```
多头仓位当前价值 = 持仓代币总量 乘以 当前指数代币价格
多头盈亏 = 多头仓位当前价值 减去 多头仓位初始成本
空头盈亏 = 空头仓位初始成本 减去 空头仓位当前价值
净盈亏 = 多头盈亏 加上 空头盈亏
扣除盈亏后池价值 = 调整后池价值 减去 净盈亏
```

**举例说明多头仓位成本**：
- 用户A：开仓时ETH价格$2000，投入$10000，获得5个ETH代币等价仓位
- 用户B：开仓时ETH价格$3000，投入$15000，获得5个ETH代币等价仓位
- 多头仓位初始成本 = $10000 + $15000 = $25000
- 持仓代币总量 = 5 + 5 = 10个ETH等价
- 如果当前ETH价格$3500，多头仓位当前价值 = 10 × $3500 = $35000
- 多头盈亏 = $35000 - $25000 = +$10000（多头盈利）

4. **减去价格影响缓冲池**
```
影响池金额 = 为价格影响预留的缓冲资金数量
影响池价值 = 影响池金额 乘以 指数代币价格
最终池价值 = 扣除盈亏后池价值 减去 影响池价值
```

**第三步: LP 份额分配计算**

系统根据三种不同情况计算新增 LP 份额：

**情况一：全新市场首次存款**
```
如果 当前LP总供应量等于零 且 池价值等于零
则 新增LP份额 = 存款总价值（按1美元等于1LP的比例）
```

**情况二：池中有资产但无LP供应**
```
如果 当前LP总供应量等于零 且 池价值大于零
则 新增LP份额 = 池价值 加上 存款总价值（按1美元等于1LP的比例）
```

**情况三：正常存款情况**
```
新增LP份额 = 现有LP总数量 乘以 存款总价值 除以 最终池价值
```

**核心公式理解**：
- **仓位成本记录机制**：
  - openInterest：所有仓位开仓时实际支付的美元成本总和
  - openInterestInTokens：所有仓位对应的代币数量总和
  - 每个仓位根据开仓时的价格确定代币数量，但成本按实际美元计算
- **盈亏计算逻辑**：
  - 多头盈亏 = （代币总量 × 当前价格）- 开仓成本总额
  - 空头盈亏 = 开仓成本总额 - （代币总量 × 当前价格）
- **池价值动态变化**：交易者盈利会减少池价值，亏损会增加池价值
- **份额分配公平性**：新LP按存款占池子总价值的比例获得份额，不稀释现有LP权益

**具体计算示例**:
```
存款价值 = 1 × $3000 + 3000 = $6000
假设:
- 池中ETH价值 = $500,000 (166.67 ETH × $3000)
- 池中USDC价值 = $400,000
- 多头仓位总盈亏 = +$50,000 (ETH价格从$2800涨到$3000)
- 空头仓位总盈亏 = -$50,000
- 未实现盈亏 = $50,000 + (-$50,000) = $0
池总价值 = $500,000 + $400,000 + $0 = $900,000
当前LP总供应量 = 100,000
LP份额铸造量 = ($6000 × 100,000) / $900,000 = 667 LP代币
```

**提款时可兑换金额**:
```
用户可提取价值 = (用户LP份额 / 总LP供应量) × 当前池总价值
用户ETH提取量 = 可提取价值 × (池中ETH占比)
用户USDC提取量 = 可提取价值 × (池中USDC占比)

示例: 如果用户持有600 LP代币，池总价值增长到$1,100,000
可提取价值 = (600 / 100,000) × $1,100,000 = $6,600
收益 = $6,600 - $6,000 = $600 (10%收益)
```

**风险考虑**: 仓位不平衡可能导致价格影响损失，但风险隔离在单一市场内

### 2.2 永续合约交易系统

#### 功能：多倍杠杆交易

**描述**：用户可以开立最高 50 倍杠杆的多空仓位

**核心需求**：
- 支持 1-50 倍可调杠杆
- 市价单、限价单、止损单多种订单类型
- 实时保证金比例监控和预警
- 一键平仓和批量平仓功能

**业务规则**：
- 最小开仓金额：等值 10 USDC
- 维持保证金比例：2%（50 倍杠杆时）
- 强制平仓触发：保证金比例 < 维持保证金比例
- 最大持仓限制：单用户最大 500 万 USDC 规模

#### 功能：智能风险控制

**描述**：多重风险控制机制保护用户和系统安全

**需求**：
- **实时监控**：保证金比例、未实现盈亏实时计算
- **预警机制**：保证金比例低于 5% 时发送预警
- **自动止损**：触发设定价格时自动平仓
- **强制平仓**：保证金不足时系统自动平仓

### 2.3 高效交换系统

#### 功能：智能路由交换

**描述**：通过多个流动性池路由，为用户提供最佳兑换价格

**核心需求**：
- 自动计算最优兑换路径
- 预估输出金额和价格影响
- 最小输出保护，防止交易执行时滑点过大
- 支持部分成交和分批执行

**业务规则**：
- 单笔交换最大金额：1000 万 USDC 等值
- 最大滑点保护：用户可设定最大容忍滑点
- 交换费用：0.05%-0.3%（根据交换金额阶梯收费）

---

## 4. 系统安全与风险防控

### 4.1 两步执行防护机制

**问题解决**：防止价格操纵和 MEV 攻击

**实施方案**：
1. **用户提交**：用户提交交易请求并支付执行费用
2. **系统执行**：专业 keeper 在下一个区块使用预言机价格执行

**安全收益**：
- 防止恶意用户通过闪电贷操纵价格获利
- 消除 MEV 机器人抢跑风险
- 确保所有用户获得公平价格

### 4.2 多重价格保护

**实施措施**：
- **多签名者价格**：要求至少 7/12 签名者提供价格数据
- **中位数机制**：取中位数价格而非平均值，降低单点风险
- **参考价格检查**：与 Chainlink 等外部价格源比较，偏差超过 2.5% 时拒绝执行
- **价格更新频率**：每 1-3 秒更新一次价格数据

### 4.3 流动性风险管理

**措施**：
- **独立池设计**：每个交易对风险完全隔离
- **最大敞口限制**：单个市场最大多头/空头敞口限制
- **动态调整费率**：根据风险敞口动态调整交易费用
- **紧急暂停机制**：发现异常时可快速暂停特定功能

 